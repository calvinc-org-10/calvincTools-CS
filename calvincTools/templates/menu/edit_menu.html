{% extends "cTools_common.html" %}

{% block customCSS %}
    td {
        border: solid;
        /*
        border-collapse: separate;
        border-spacing: 5px;
        */
        padding: 1em;
    }
{% endblock %}


{% block formName %}Edit Menu{% endblock %}
{% block tTitle %}{{ menuName }}{% endblock %}
<!-- menu head -->
{% block Hdr_LogoFormNameUserName %}
<div class="row max-width=100%">
    <div class="col-2 text-start"></div>
    <div class="col-8 text-center">
        <h5>
        Menu Group <select id="menuGroup" onchange="loadNewMenu(true);">
        {% for ch in menuGoto.menuGroup_choices %}
            <option value="{{ ch.id }}"
            {% if ch.id == menuGoto.menuGroup %}  selected {% endif %}
            >{{ ch }}</option>"
        {% endfor %}
        </select>  <small>{{ menuGoto.menuGroup }}</small>
        <small><button type="button" id="NewMenuGroup">New Mnu Grp</button></small>
        <br>
        Menu <select id="menuID" onchange="loadNewMenu(false);">
        {% for ch in menuGoto.menuID_choices %}
            <option value="{{ ch.MenuID }}"
            {% if ch.MenuID == menuGoto.menuID %}  selected {% endif %}
            >{{ ch }}</option>"
        {% endfor %}
        </select>
        </h5>
    </div>
    <div class="col-2 text-end">{{ current_user.username }}</div>
</div>
<div class="row max-width=100%">
    <div class="col-1 text-start"></div>
    <div class="col-8 text-center">
        GroupName: {{ form.menu_group.GroupName(form="menueditForm") }}
        GroupInfo: {{ form.menu_group.GroupInfo(form="menueditForm") }}
        MenuName: {{ form.menu_name(size=15, form="menueditForm") }} {# <input type="text" name="menuName" form="menueditForm" value="{{ menuName }}" size="15"> #}
    </div>
    <div class="col-2">
        <button type="button" id="CopyMenu">Copy Menu</button>
        <button type="button" id="NewMenu">New Menu</button>
        <button type="button" id="RemvMenu">Remv Menu</button>
    </div>
</div>
{% endblock %}
{#
{% block statusMsgs %}
    {% if session.changed_data %}
        <div class="alert alert-success p-0 alert-dismissible fade show">
            <button type="button" class="btn-close p-0" data-bs-dismiss="alert"></button>
            Changes successfully saved.
            ChDat: {{ session.changed_data }}
        </div>
    {% endif %}
{% endblock %}
#}
{% block boddy %}
<form method="POST" id="menueditForm">
    {{ form.hidden_tag() }}
    
    <table class="container">
        {% for i in range(10) %}
        {% set mItem_i = form.menu_items[i].form %}
        {% set mItem_i10 = form.menu_items[i+10].form %}
        <tr>
            <td>
                <span class='row'>
                    {{ mItem_i.OptionNumber.data }}
                    {% if mItem_i.id.data is not none %}(id {{ mItem_i.id.data }}){% endif %}
                    {{+ mItem_i.OptionText(style="width: 400px;") }}
                </span>
                <div class="row">
                    Command:  {{ mItem_i.Command(style="width: 150px;") }}
                    Argument: {{ mItem_i.Argument(style="width: 250px;") }}
                </div>
                <div class="row">
                    <div class="col-3">
                        {{ mItem_i.CopyType() }}
                    </div>
                    <div class="col-3">
                        to {{ mItem_i.CopyTarget(style="width: 100px;") }}
                    </div>
                    <div class="col">
                        | {{mItem_i.Remove.label }}: {{ mItem_i.Remove }}
                    </div>
                </div>
            </td>
            <td>
                <span class='row'>
                    {{ mItem_i10.OptionNumber.data }}
                    {% if mItem_i10.id.data is not none %}(id {{ mItem_i10.id.data }}){% endif %}
                    {{+ mItem_i10.OptionText(style="width: 400px;") }}
                </span>
                <div class="row">
                    Command:  {{ mItem_i10.Command(style="width: 150px;") }}
                    Argument: {{ mItem_i10.Argument(style="width: 250px;") }}
                </div>
                <div class="row">
                    <div class="col-3">
                        {{ mItem_i10.CopyType() }}
                    </div>
                    <div class="col-3">
                        to {{ mItem_i10.CopyTarget(style="width: 100px;") }}
                    </div>
                    <div class="col">
                        | {{mItem_i10.Remove.label }}: {{ mItem_i10.Remove }}
                    </div>
                </div>
            </td>
        </tr>
        {% endfor %}
    </table>
    
    {#
    {{ form.submit() }} should I use this or button below?
    #}
    <!-- form footer -->
    <br>
    <div class="container">
        <div class="row mx-auto max-width=100%">
            <div class="col-4">
                <button id="save_btn" type="submit">
                    <img src="{{ url_for('ctools.static', filename='svg/poem-poetry-icon.svg') }}" width="20" height="20"></img>
                    Save changes
                </button>
            </div>
            <div class="col-6"></div>
            <div class="col">
                <button id="close_btn" type="button" onclick="window.close();">
                    <img src="{{ url_for('ctools.static', filename='svg/stop-road-sign-icon.svg') }}" width="20" height="20"></img>
                    Close Form
                </button>
            </div>
        </div>
    </div>
</form>
    
<dialog id="get-MenuID-dialog">
    <form method="dialog" id="menuForm">
        <fieldset>
            <legend>New Menu Group/ID</legend>
            
            <label for="NewMnuGroup">Menu Group</label>
            <input type="number" name="NewMnuGroup" id="NewMnuGroup">
            
            <label for="NewMnuID">Menu ID</label>
            <input type="number" name="NewMnuID" id="NewMnuID">
            
            <div style="margin-top:1em;">
                <button type="button" id="menu-ok">OK</button>
                <button type="button" id="menu-cancel">Cancel</button>
            </div>
        </fieldset>
    </form>
</dialog>
<dialog id="get-GroupID-dialog">
    <form method="dialog" id="groupForm">
        <fieldset>
            <legend>New Menu Group</legend>
            
            <label for="NewMnuGroup_G">Menu Group</label>
            <input type="number" name="NewMnuGroup" id="NewMnuGroup_G">
            
            <label for="NewMnuGroupName_G">Menu Group Name</label>
            <input type="text" name="NewMnuGroupName" id="NewMnuGroupName_G">
            
            <label for="NewMnuGroupDesc_G">Menu Group Description</label>
            <input type="text" name="NewMnuGroupDesc" id="NewMnuGroupDesc_G">
            
            <div style="margin-top:1em;">
                <button type="button" id="group-ok">OK</button>
                <button type="button" id="group-cancel">Cancel</button>
            </div>
        </fieldset>
    </form>
</dialog>

<script>
    
let CopyORNew = ''      // menu copy type used by NewMenu procs

// buttons and dialog elements
const newGroupBtn = document.getElementById("NewMenuGroup");
const copyBtn = document.getElementById("CopyMenu");
const newBtn  = document.getElementById("NewMenu");
const remvBtn = document.getElementById("RemvMenu");

const getMenuIDdialog = document.getElementById("get-MenuID-dialog");
const menuIDdlg_okBtn = document.getElementById("menu-ok");
const menuIDdlg_cancelBtn = document.getElementById("menu-cancel");
const getGroupIDdialog = document.getElementById("get-GroupID-dialog");
const groupIDdlg_okBtn = document.getElementById("group-ok");
const groupIDdlg_cancelBtn = document.getElementById("group-cancel");

// event listeners
newGroupBtn.addEventListener("click", () => openNewGroupDialog());
copyBtn.addEventListener("click", () => openMenuDialog("copy"));
newBtn.addEventListener("click",  () => openMenuDialog("new"));
remvBtn.addEventListener("click", () => { });

function openMenuDialog(mode) {
    CopyORNew = mode;
    getMenuIDdialog.showModal();
}

// disable Escape key (closeOnEscape:false)
getMenuIDdialog.addEventListener("cancel", function (e) {
    e.preventDefault();
});
menuIDdlg_okBtn.addEventListener("click", function () {
    NewMenuID_chosen();
    dialog.close();
});
menuIDdlg_cancelBtn.addEventListener("click", function () {
    dialog.close();
});

function NewMenuID_chosen() {
    var newRec;

    valNewMnuGrp = document.getElementById('NewMnuGroup').value;
    valNewMnuID = document.getElementById('NewMnuID').value;
    valFromMnuGrp = document.getElementById('menuGroup').value;
    valFromMnuID = document.getElementById('menuID').value;
    
    if (CopyORNew == 'copy') {
        newRec = "{{ url_for('menu.create_menu', menu_group=-101, menu_num=-102, from_group=-103, from_menu=-104) }}";
    } else if (CopyORNew == 'new') {
        newRec = "{{ url_for('menu.create_menu', menu_group=-101, menu_num=-102) }}";
    } else {
        // something is wrong
    }
    newRec = newRec.replace('/-101','/'+valNewMnuGrp);
    newRec = newRec.replace('/-102','/'+valNewMnuID);
    newRec = newRec.replace('/-103','/'+valFromMnuGrp);
    newRec = newRec.replace('/-104','/'+valFromMnuID);        
    window.location = newRec;
}

function openNewGroupDialog() {
    // similar to openMenuDialog but only asks for new group number
    getGroupIDdialog.showModal();
}

// disable Escape key (closeOnEscape:false)
getGroupIDdialog.addEventListener("cancel", function (e) {
    e.preventDefault();
});
groupIDdlg_okBtn.addEventListener("click", function () {
    NewMenuGroup_chosen();
    dialog.close();
});
groupIDdlg_cancelBtn.addEventListener("click", function () {
    dialog.close();
});

function NewMenuGroup_chosen() {
    var newRec;

    valNewGrpID = document.getElementById('NewMnuGroup_G').value;
    valNewGrpName = document.getElementById('NewMnuGroupName_G').value;
    valNewGrpInfo = document.getElementById('NewMnuGroupDesc_G').value;
    
    // newRec = "{{ url_for('menu.create_group', group_id=-101, group_name=valNewGrpName, group_info=valNewGrpInfo) }}";
    newRec = "{{ url_for('menu.create_group', group_id=-101, group_name='New Group', group_info='') }}";
    newRec = newRec.replace('/-101','/'+valNewGrpID);

    window.location = newRec;
}

$("#RemvMenu").on("click", function() {
    // are you sure?    {# use areYouSure() (in cTools_common.html) #}
    $("#yesno-dialog-text").html("Are you <b>SURE</b> you want to remove this menu?")  // is there a way I can pass this to the dialog object?
    $("#yesno-dialog").dialog("open")
});    

function yesno_chosen(yesnoVal) {
    if (yesnoVal) {
        //OK, kill this menu
        newRec = "" {# "{% url 'MenuRemove' 'menuGroup' 'menuNum' %}" #}
        newRec = newRec.replace('/menuGroup','/'+$('#menuGroup').val())
        newRec = newRec.replace('/menuNum','/'+$('#menuID').val())
        window.location = newRec;

    } else {
        // nope, don't really wanna destroy this menu; carry on
    }
}
  
function loadNewMenu(anothrGrp) {

    gotoGroup = document.getElementById('menuGroup').value;
    if (anothrGrp) {
        gotoMenu = 0;
    } else {
        gotoMenu = document.getElementById('menuID').value;
    }

    var newRec = "{{ url_for('menu.edit_menu', group_id=-101, menu_num=-102) }}"
    newRec = newRec.replace('/-101','/'+gotoGroup);
    newRec = newRec.replace('/-102','/'+gotoMenu);
    window.location = newRec;
}

document.body.onbeforeunload = function() {
    document.getElementById("wait_spinner").style.display = "block";
}

{# use areYouSure() (in cTools_common.html)
    $("#yesno-dialog").dialog({
        autoOpen: false,
        closeOnEscape: false,
        modal: true,
        buttons: {
            "Yes": function() {
                yesno_chosen(true);
                $(this).dialog("close");
            },
            "No":  function() {
                yesno_chosen(false);
                $(this).dialog("close");
            }
        }
    });
    $("#yesno-dialog").find( "button" ).on( "click", function( event ) {
        // event.preventDefault();
        yesno_chosen();
        $("yesno-dialog").close()
    });
#}

</script>

{% endblock %}