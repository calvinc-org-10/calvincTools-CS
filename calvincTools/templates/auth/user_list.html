{% extends "cTools_common.html" %}

{% block tTitle %}User Management{% endblock %}

{% block formName %}User Management{% endblock %}

{% block customCSS %}
<style>
    .badge {
        display: inline-block;
        font-size: 0.875rem;
    }
    
    .make-inactive-btn {
        min-width: 120px;
    }
    
    .table-responsive {
        margin-top: 20px;
    }
    
    .user-row td {
        vertical-align: middle;
    }
    
    .form-control {
        font-size: 0.9rem;
    }
    
    .form-check {
        padding-top: 0.5rem;
    }
</style>
{% endblock %}

{% block boddy %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
        <form method="POST" action="{{ url_for('auth.user_list') }}" id="userListForm">
            {{ form.hidden_tag() }}
                
                <div class="table-responsive">
                    <table class="table table-bordered table-striped" id="userTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Password</th>
                                <th>Active Status</th>
                                <th>Superuser</th>
                                <th>Permissions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            {% for user_form in form.users %}
                                <tr class="user-row" data-user-index="{{ loop.index0 }}">
                                    <!-- Username -->
                                    <td>
                                        {{ user_form.username(class="form-control") }}
                                        {% if user_form.username.errors %}
                                            <div class="text-danger small">
                                                {% for error in user_form.username.errors %}
                                                    {{ error }}<br>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Email -->
                                    <td>
                                        {{ user_form.email(class="form-control") }}
                                        {% if user_form.email.errors %}
                                            <div class="text-danger small">
                                                {% for error in user_form.email.errors %}
                                                    {{ error }}<br>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Password -->
                                    <td>
                                        {{ user_form.password(class="form-control", autocomplete="new-password") }}
                                        {% if user_form.password.errors %}
                                            <div class="text-danger small">
                                                {% for error in user_form.password.errors %}
                                                    {{ error }}<br>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Active Status -->
                                    <td class="align-middle">
                                        {% set username_value = user_form.username.data or '' %}
                                        {% if username_value.strip() %}
                                            <!-- This is an existing user, show status/action button -->
                                            {% if user_form.FLDis_active.data %}
                                                <button type="button" class="btn btn-sm btn-warning make-inactive-btn" 
                                                        data-user-index="{{ loop.index0 }}"
                                                        title="Click to mark user as inactive">
                                                    Make Inactive
                                                </button>
                                            {% else %}
                                                <span class="badge" style="background-color: #dc3545; color: white; padding: 8px 12px;">
                                                    INACTIVE
                                                </span>
                                            {% endif %}
                                            <input type="hidden" name="users-{{ loop.index0 }}-FLDis_active" 
                                                   value="{{ user_form.FLDis_active.data|int }}" 
                                                   class="dis-active-input">
                                        {% else %}
                                            <!-- This is a blank row for new user -->
                                            <div class="form-check">
                                                {{ user_form.FLDis_active(class="form-check-input") }}
                                                <label class="form-check-label">Active</label>
                                            </div>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Superuser -->
                                    <td class="align-middle">
                                        <div class="form-check">
                                            {{ user_form.is_superuser(class="form-check-input") }}
                                        </div>
                                    </td>
                                    
                                    <!-- Permissions -->
                                    <td>
                                        {{ user_form.permissions(class="form-control", rows="2") }}
                                        {% if user_form.permissions.errors %}
                                            <div class="text-danger small">
                                                {% for error in user_form.permissions.errors %}
                                                    {{ error }}<br>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-secondary" id="addMoreUsersBtn">
                        Add {{ blank_user_count }} More Users
                    </button>
                    {{ form.submit(class="btn btn-primary") }}
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const blank_user_count = {{ blank_user_count }};
    let nextIndex = document.querySelectorAll('.user-row').length;
    
    // Handle "Make Inactive" button clicks
    document.querySelectorAll('.make-inactive-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const userIndex = this.dataset.userIndex;
            const row = document.querySelector(`[data-user-index="${userIndex}"]`);
            const disActiveInput = row.querySelector('.dis-active-input');
            
            // Toggle the state
            if (disActiveInput.value === '1') {
                disActiveInput.value = '0';
                // Show INACTIVE badge instead of button
                this.replaceWith(
                    `<span class="badge" style="background-color: #dc3545; color: white; padding: 8px 12px;">
                        INACTIVE
                    </span>`
                );
            } else {
                disActiveInput.value = '1';
                // Show Make Inactive button instead of badge
                this.style.display = '';
            }
        });
    });
    
    // Handle "Add More Users" button
    document.getElementById('addMoreUsersBtn').addEventListener('click', function() {
        addBlankUserRows(blank_user_count);
    });
    
    function addBlankUserRows(count) {
        const tbody = document.getElementById('userTableBody');
        const currentRowCount = document.querySelectorAll('.user-row').length;
        
        for (let i = 0; i < count; i++) {
            const newIndex = currentRowCount + i;
            const newRow = createBlankUserRow(newIndex);
            tbody.appendChild(newRow);
        }
        
        // Re-initialize event listeners for the new "Make Inactive" buttons
        document.querySelectorAll('.make-inactive-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const userIndex = this.dataset.userIndex;
                const row = document.querySelector(`[data-user-index="${userIndex}"]`);
                const disActiveInput = row.querySelector('.dis-active-input');
                
                if (disActiveInput && disActiveInput.value === '1') {
                    disActiveInput.value = '0';
                    this.replaceWith(
                        `<span class="badge" style="background-color: #dc3545; color: white; padding: 8px 12px;">
                            INACTIVE
                        </span>`
                    );
                }
            });
        });
    }
    
    function createBlankUserRow(index) {
        const row = document.createElement('tr');
        row.className = 'user-row';
        row.dataset.userIndex = index;
        
        // Build field names following WTForms FieldList naming convention
        const baseName = `users-${index}-`;
        
        row.innerHTML = `
            <!-- Username -->
            <td>
                <input class="form-control" id="${baseName}username" 
                       name="${baseName}username" type="text">
            </td>
            
            <!-- Email -->
            <td>
                <input class="form-control" id="${baseName}email" 
                       name="${baseName}email" type="email">
            </td>
            
            <!-- Password -->
            <td>
                <input class="form-control" id="${baseName}password" 
                       name="${baseName}password" type="password"
                       autocomplete="new-password">
            </td>
            
            <!-- Active Status (checkbox for new blank rows) -->
            <td class="align-middle">
                <div class="form-check">
                    <input class="form-check-input" id="${baseName}FLDis_active" 
                           name="${baseName}FLDis_active" type="checkbox" value="y" checked>
                    <label class="form-check-label" for="${baseName}FLDis_active">Active</label>
                </div>
            </td>
            
            <!-- Superuser -->
            <td class="align-middle">
                <div class="form-check">
                    <input class="form-check-input" id="${baseName}is_superuser" 
                           name="${baseName}is_superuser" type="checkbox" value="y">
                </div>
            </td>
            
            <!-- Permissions -->
            <td>
                <textarea class="form-control" id="${baseName}permissions" 
                          name="${baseName}permissions" rows="2"></textarea>
            </td>
        `;
        
        return row;
    }
});
</script>
{% endblock %}
